<doctype html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no"/>
    <title>chrome127-offscreen</title>
    <style>
      body { margin: 0; background-color: black }
      .game {
        position: absolute;
        top: 0px;
        left: 0px;
        margin: 0px;
        border: 0;
        width: 100%;
        height: 100%;
        overflow: hidden;
        display: block;
        image-rendering: optimizeSpeed;
        image-rendering: -moz-crisp-edges;
        image-rendering: -o-crisp-edges;
        image-rendering: -webkit-optimize-contrast;
        image-rendering: optimize-contrast;
        image-rendering: crisp-edges;
        image-rendering: pixelated;
        -ms-interpolation-mode: nearest-neighbor;
      }
    </style>
  </head>
  <body>
    <canvas class="game" id="canvas" oncontextmenu="event.preventDefault()"></canvas>
    <script type="text/javascript">
      "use strict"

      const vs_src = `#version 300 es
        const vec2 pos[4] = vec2[](vec2(0,0),vec2(1,0),vec2(0,1),vec2(1,1));
        out vec2 uv;
        void main() {
          gl_Position = vec4(pos[gl_VertexID] - 0.5, 0.5, 1.0);
          uv = pos[gl_VertexID];
        }`;
      const fs_src = `#version 300 es
        precision highp float;
        precision highp int;
        uniform highp sampler2D tex_smp;
        layout(location = 0) out highp vec4 frag_color;
        in highp vec2 uv;
        void main() {
          frag_color = texture(tex_smp, uv);
        }`;

      function main() {
        const canvas = document.querySelector("#canvas");
        const gl = canvas.getContext("webgl2");

        // create render target texture
        const img = gl.createTexture();
        gl.bindTexture(gl.TEXTURE_2D, img);
        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAX_LEVEL, 0);
        gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, 256, 256, 0, gl.RGBA, gl.UNSIGNED_BYTE, null);

        // create a sampler object
        const smp = gl.createSampler();
        gl.samplerParameteri(smp, gl.TEXTURE_MIN_FILTER, gl.NEAREST);
        gl.samplerParameteri(smp, gl.TEXTURE_MAG_FILTER, gl.NEAREST);
        gl.samplerParameterf(smp, gl.TEXTURE_MIN_LOD, 0);
        gl.samplerParameterf(smp, gl.TEXTURE_MAX_LOD, 1000);
        gl.samplerParameteri(smp, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);
        gl.samplerParameteri(smp, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);
        gl.samplerParameteri(smp, gl.TEXTURE_WRAP_R, gl.CLAMP_TO_EDGE);
        gl.samplerParameteri(smp, gl.TEXTURE_COMPARE_MODE, gl.NONE);

        // create a framebuffer object for offscreen rendering
        const fb = gl.createFramebuffer();
        gl.bindFramebuffer(gl.FRAMEBUFFER, fb);
        gl.framebufferTexture2D(gl.FRAMEBUFFER, gl.COLOR_ATTACHMENT0, gl.TEXTURE_2D, img, 0);
        gl.drawBuffers([gl.COLOR_ATTACHMENT0]);
        gl.bindFramebuffer(gl.FRAMEBUFFER, null);

        // create shader program
        const vs_shd = gl.createShader(gl.VERTEX_SHADER);
        gl.shaderSource(vs_shd, vs_src);
        gl.compileShader(vs_shd);
        const fs_shd = gl.createShader(gl.FRAGMENT_SHADER);
        gl.shaderSource(fs_shd, fs_src);
        gl.compileShader(fs_shd);
        const prog = gl.createProgram();
        gl.attachShader(prog, vs_shd);
        gl.attachShader(prog, fs_shd);
        gl.linkProgram(prog);
        gl.deleteShader(vs_shd);
        gl.deleteShader(fs_shd);
        gl.useProgram(prog);
        const img_loc = gl.getUniformLocation(prog, "tex_smp");
        gl.uniform1i(img_loc, 0);

        requestAnimationFrame(drawFrame);

        let g = 0.0;
        function drawFrame(time) {
          // offscreen rendering
          g += 0.01;
          if (g > 1.0) {
            g =  0.0;
          }
          gl.bindFramebuffer(gl.FRAMEBUFFER, fb);
          gl.depthFunc(gl.ALWAYS);
          gl.depthMask(true);
          gl.stencilMask(255);
          gl.clearBufferfv(gl.COLOR, 0, [1, g, 0, 1]);

          // render default pass
          gl.bindFramebuffer(gl.FRAMEBUFFER, null);
          gl.depthMask(true);
          gl.stencilMask(255);
          gl.clearBufferfv(gl.COLOR, 0, [0.5, 0.5, 0.5, 1.0]);
          gl.disable(gl.CULL_FACE);
          gl.activeTexture(gl.TEXTURE0);
          gl.bindTexture(gl.TEXTURE_2D, img);
          gl.bindSampler(0, smp);
          gl.drawArrays(gl.TRIANGLE_STRIP, 0, 4);

          requestAnimationFrame(drawFrame);
        }
      }
      main();
    </script>
  </body>
</html>
</doctype>